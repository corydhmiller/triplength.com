---
interface Props {
	label: string;
	id: string;
	placeholder?: string;
	initialValue?: string;
}

const { label, id, placeholder, initialValue } = Astro.props;
---

<div class="field timezone-field" data-timezone-select>
	<label>{label}</label>
	<div class="searchable-select">
		<input 
			type="text" 
			class="tz-search" 
			placeholder={placeholder || "Search city, region or code..."} 
			autocomplete="off"
		/>
		<input type="hidden" id={id} name={id} value={initialValue} required />
		<div class="tz-dropdown hidden"></div>
	</div>
</div>

<script>
	import { DateTime } from 'luxon';
	import cityTimezones from 'city-timezones';

	// Timezone Data - Computed once per page load, shared by all instances
	const ianaZones = Intl.supportedValuesOf('timeZone');
	
	const baseTimezoneData = ianaZones.map(zone => {
		const parts = zone.split('/');
		const region = parts[0];
		const city = parts[parts.length - 1].replace(/_/g, ' ');
		const now = DateTime.now().setZone(zone);
		return {
			id: zone,
			region,
			city,
			abbr: now.offsetNameShort,
			searchString: `${zone} ${region} ${city} ${now.offsetNameShort}`.toLowerCase()
		};
	});

	const cityData = cityTimezones.cityMapping.map((city: any) => {
		const now = DateTime.now().setZone(city.timezone);
		return {
			id: city.timezone,
			region: city.province || city.country,
			city: city.city,
			abbr: now.offsetNameShort,
			searchString: `${city.city} ${city.province} ${city.country} ${city.timezone} ${now.offsetNameShort}`.toLowerCase()
		};
	});

	const combinedData = [...baseTimezoneData, ...cityData];
	const seen = new Set();
	const timezoneData = combinedData.filter(item => {
		const key = `${item.city}-${item.id}`;
		if (seen.has(key)) return false;
		seen.add(key);
		return true;
	});

	// Logic for each component instance
	function initTimezoneSelectors() {
		const containers = document.querySelectorAll('[data-timezone-select]:not([data-initialized])');
		
		containers.forEach(container => {
			const searchInput = container.querySelector('.tz-search') as HTMLInputElement;
			const hiddenInput = container.querySelector('input[type="hidden"]') as HTMLInputElement;
			const dropdown = container.querySelector('.tz-dropdown') as HTMLDivElement;

			container.setAttribute('data-initialized', 'true');

			// Set initial label if value exists
			if (hiddenInput.value) {
				const initialZone = timezoneData.find(z => z.id === hiddenInput.value);
				if (initialZone) {
					searchInput.value = `${initialZone.city} (${initialZone.abbr})`;
				}
			}

			function renderDropdown(filter = '') {
				const filterLower = filter.toLowerCase();
				const filtered = timezoneData
					.filter(z => z.searchString.includes(filterLower))
					.sort((a, b) => {
						const aCity = a.city.toLowerCase();
						const bCity = b.city.toLowerCase();
						if (aCity === filterLower && bCity !== filterLower) return -1;
						if (bCity === filterLower && aCity !== filterLower) return 1;
						return 0;
					})
					.slice(0, 50);

				dropdown.innerHTML = '';
				
				filtered.forEach(z => {
					const item = document.createElement('div');
					item.className = 'tz-item';
					item.tabIndex = 0;
					item.innerHTML = `
						<div class="tz-item-main">${z.city} <small>${z.region}</small></div>
						<div class="tz-item-meta">${z.abbr} â€” ${z.id}</div>
					`;
					
					const selectItem = (e: Event) => {
						e.stopPropagation(); // Prevent document click from firing
						hiddenInput.value = z.id;
						searchInput.value = `${z.city} (${z.abbr})`;
						dropdown.classList.add('hidden');
						hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
					};

					item.addEventListener('click', selectItem);
					item.addEventListener('keydown', (e) => {
						if (e.key === 'Enter') selectItem(e);
					});
					dropdown.appendChild(item);
				});

				if (filtered.length === 0) {
					const noResults = document.createElement('div');
					noResults.className = 'tz-no-results';
					noResults.textContent = 'No timezones found';
					dropdown.appendChild(noResults);
				}
			}

			searchInput.addEventListener('focus', () => {
				renderDropdown(searchInput.value);
				dropdown.classList.remove('hidden');
			});

			searchInput.addEventListener('input', () => {
				renderDropdown(searchInput.value);
				dropdown.classList.remove('hidden');
			});

			// Close dropdown when clicking outside
			document.addEventListener('click', (e) => {
				if (!container.contains(e.target as Node)) {
					dropdown.classList.add('hidden');
				}
			});
		});
	}

	// Run on initial load
	initTimezoneSelectors();

	// Run on view transitions if enabled
	document.addEventListener('astro:page-load', initTimezoneSelectors);
</script>

<style>
	.field {
		margin-bottom: 1.2rem;
		display: flex;
		flex-direction: column;
	}

	label {
		font-size: 0.85rem;
		margin-bottom: 0.4rem;
		font-weight: 600;
		color: var(--text);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.searchable-select {
		position: relative;
	}

	input.tz-search {
		width: 100%;
		padding: 0.75rem;
		border: 1px solid var(--border-color);
		border-radius: var(--radius-md);
		font-size: 1rem;
		color: var(--text);
		background: var(--white);
		transition: border-color 0.2s, box-shadow 0.2s;
	}

	input.tz-search:focus {
		outline: none;
		border-color: var(--primary);
		box-shadow: 0 0 0 3px var(--primary-soft);
	}

	.tz-dropdown {
		position: absolute;
		top: calc(100% + 4px);
		left: 0;
		right: 0;
		background: var(--white);
		border: 1px solid var(--border-color);
		border-radius: var(--radius-lg);
		max-height: 300px;
		overflow-y: auto;
		overflow-x: hidden;
		z-index: 10;
		box-shadow: var(--shadow-lg);
	}
</style>
