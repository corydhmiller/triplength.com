---
import Layout from '../layouts/Layout.astro';
import TimezoneSelect from '../components/TimezoneSelect.astro';
import { DateTime } from 'luxon';

const userZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
const now = DateTime.now();
const defaultDepDate = now.toISODate();
const defaultDepTime = now.toFormat('HH:mm');
const defaultArrDate = now.toISODate();
const defaultArrTime = now.plus({ hours: 2 }).toFormat('HH:mm');
---

<Layout>
	<main>
		<h1>How long will my trip be?</h1>
		
		<form id="trip-form">
			<div class="grid">
				<section>
					<h2>Departure</h2>
					<div class="field">
						<label for="dep-date">Date</label>
						<input type="date" id="dep-date" value={defaultDepDate} required />
					</div>
					<div class="field">
						<label for="dep-time">Time</label>
						<input type="time" id="dep-time" value={defaultDepTime} required />
					</div>
					<TimezoneSelect 
						label="Timezone" 
						id="dep-zone" 
						initialValue={userZone} 
						placeholder="Departure city, region..."
					/>
				</section>

				<section>
					<h2>Arrival</h2>
					<div class="field">
						<label for="arr-date">Date</label>
						<input type="date" id="arr-date" value={defaultArrDate} required />
					</div>
					<div class="field">
						<label for="arr-time">Time</label>
						<input type="time" id="arr-time" value={defaultArrTime} required />
					</div>
					<TimezoneSelect 
						label="Timezone" 
						id="arr-zone" 
						initialValue={userZone} 
						placeholder="Arrival city, region..."
					/>
				</section>
			</div>

			<button type="submit">Calculate Duration</button>
		</form>

		<div id="result" class="result hidden">
			<h3>Trip Duration</h3>
			<p id="duration-text"></p>
		</div>
	</main>
</Layout>

<script>
	import { calculateTripDuration } from '../utils/duration';

	const form = document.getElementById('trip-form') as HTMLFormElement;
	const resultDiv = document.getElementById('result') as HTMLDivElement;
	const durationText = document.getElementById('duration-text') as HTMLParagraphElement;

	form.addEventListener('submit', (e) => {
		e.preventDefault();

		const departure = {
			date: (document.getElementById('dep-date') as HTMLInputElement).value,
			time: (document.getElementById('dep-time') as HTMLInputElement).value,
			timezone: (document.getElementById('dep-zone') as HTMLInputElement).value
		};

		const arrival = {
			date: (document.getElementById('arr-date') as HTMLInputElement).value,
			time: (document.getElementById('arr-time') as HTMLInputElement).value,
			timezone: (document.getElementById('arr-zone') as HTMLInputElement).value
		};

		try {
			const result = calculateTripDuration(departure, arrival);
			durationText.textContent = result.formatted;
		} catch (error) {
			durationText.textContent = 'Invalid date or time selected.';
		}

		resultDiv.classList.remove('hidden');
		resultDiv.scrollIntoView({ behavior: 'smooth' });
	});
</script>

<style>
	.grid {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: var(--spacing-lg);
		margin-bottom: var(--spacing-lg);
	}

	@media (max-width: 768px) {
		.grid {
			grid-template-columns: 1fr;
		}
	}

	section {
		padding: var(--spacing-md);
		background: var(--white);
		border: 1px solid var(--border-color);
		border-radius: var(--radius-lg);
		box-shadow: var(--shadow-sm);
	}

	h2 {
		font-size: 1.2rem;
		margin-top: 0;
		margin-bottom: var(--spacing-md);
		color: var(--text);
		border-bottom: 2px solid var(--accent);
		display: inline-block;
	}

	.field {
		margin-bottom: 1.2rem;
		display: flex;
		flex-direction: column;
	}

	label {
		font-size: 0.85rem;
		margin-bottom: 0.4rem;
		font-weight: 600;
		color: var(--text);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	input {
		padding: 0.75rem;
		border: 1px solid var(--border-color);
		border-radius: var(--radius-md);
		font-size: 1rem;
		color: var(--text);
		background: var(--white);
		transition: border-color 0.2s, box-shadow 0.2s;
	}

	input:focus {
		outline: none;
		border-color: var(--primary);
		box-shadow: 0 0 0 3px var(--primary-soft);
	}

	button {
		width: 100%;
		max-width: 400px;
		margin: 0 auto;
		display: block;
		padding: 1.2rem;
		background-color: var(--primary);
		color: white;
		border: none;
		border-radius: var(--radius-lg);
		font-size: 1.2rem;
		font-weight: 700;
		cursor: pointer;
		transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
		box-shadow: 0 4px 12px oklch(from var(--primary) l c h / 0.3);
	}

	button:hover {
		background-color: var(--primary-hover);
		transform: translateY(-2px);
		box-shadow: 0 6px 16px oklch(from var(--primary) l c h / 0.4);
	}

	button:active {
		transform: translateY(0);
	}

	.result {
		margin-top: var(--spacing-xl);
		padding: 2.5rem;
		background: var(--white);
		border: 2px solid var(--accent);
		border-radius: var(--radius-xl);
		text-align: center;
	}

	.result h3 {
		margin-top: 0;
		font-size: 1.1rem;
		color: var(--accent-dark);
		text-transform: uppercase;
		letter-spacing: 0.1em;
	}

	.result p {
		margin: var(--spacing-xs) 0 0;
		font-size: 2.5rem;
		font-weight: 800;
		color: var(--primary);
	}

</style>
